#!/usr/bin/env bash
set -euo pipefail
. functions.sh

export REGION="${1}"
export CLUSTER_NAME="${2}"
network="${3}"
generation="${4}"

bin/eksler create $REGION $CLUSTER_NAME $network
export KUBECONFIG=$(bin/eksler with $REGION $CLUSTER_NAME kubeconfig)

export POOLS=${POOLS:-}
for pool in $POOLS; do
  (
    match=$(bin/ekslerpooler get $REGION $CLUSTER_NAME $generation $pool)
    if [ "$match" != "" ]; then
      _output "pool $pool already exists, skip"
    else
      bin/pools $pool $REGION $CLUSTER_NAME $generation
    fi

    _done
  ) 2>&1 | sed -le "s#^# ++ pool: $pool: #;" &
done

wait $(jobs -p)

bin/eksler with $REGION $CLUSTER_NAME list

bin/helmer apply \
  cluster-autoscaler-1 \
  https://kubernetes.github.io/autoscaler cluster-autoscaler 9.11.0 \
  helm/values/cluster-autoscaler-1.yml

bin/helmer apply \
  aws-load-balancer-controller-1 \
  https://aws.github.io/eks-charts aws-load-balancer-controller 1.3.3 \
  helm/values/aws-load-balancer-controller-1.yml

bin/helmer apply \
  ingress-nginx-1 \
  https://kubernetes.github.io/ingress-nginx ingress-nginx 4.0.16 \
  helm/values/ingress-nginx-1.yml

bin/helmer apply \
  prometheus-1 \
  https://prometheus-community.github.io/helm-charts prometheus 15.0.4 \
  helm/values/prometheus-1.yml

_done
echo ""
