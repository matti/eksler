#!/usr/bin/env bash
set -euo pipefail
. functions.sh

export REGION="${1}"
export CLUSTER_NAME="${2}"
network="${3}"
generation="${4}"

bin/eksler create $REGION $CLUSTER_NAME $network
export KUBECONFIG=$(bin/eksler with $REGION $CLUSTER_NAME kubeconfig)

export POOLS=${POOLS:-}
for pool in $POOLS; do
  (
    match=$(bin/ekslerpooler get $REGION $CLUSTER_NAME $generation $pool)
    if [ "$match" != "" ]; then
      _output "pool $pool already exists, skip"
    else
      bin/pools $pool $REGION $CLUSTER_NAME $generation
    fi

    _done
  ) 2>&1 | sed -le "s#^# ++ pool: $pool: #;" &
done

wait $(jobs -p)

bin/eksler with $REGION $CLUSTER_NAME list

bin/helmer create \
  cluster-autoscaler-1 \
  https://kubernetes.github.io/autoscaler cluster-autoscaler 9.11.0 \
  helm/values/cluster-autoscaler-1.yml

bin/helmer create \
  aws-load-balancer-controller-1 \
  https://aws.github.io/eks-charts aws-load-balancer-controller 1.3.3 \
  helm/values/aws-load-balancer-controller-1.yml

bin/helmer create \
  ingress-nginx-1 \
  https://kubernetes.github.io/ingress-nginx ingress-nginx 4.0.16 \
  helm/values/ingress-nginx-1.yml

bin/helmer create \
  prometheus-1 \
  https://prometheus-community.github.io/helm-charts prometheus 15.0.4 \
  helm/values/prometheus-1.yml

_forever kubectl apply -f tests/eksler-test-1.yml

_output "waiting for lb hostname:"

lb_hostname=$(_forever_any \
    kubectl get service -n eksler-test-1 whoami-lb \
      --output=jsonpath='{.status.loadBalancer.ingress[0].hostname}'
)

_output "waiting for lb to respond ok:"
_forever curl -fsL $lb_hostname

ingress_hostname=$(_forever_any \
  kubectl get ingress -n eksler-test-1 whoami --output=jsonpath='{.status.loadBalancer.ingress[0].hostname}'
)

_output "waiting for ingress to respond ok:"
_forever "curl -fL -H 'Host: todo' $ingress_hostname"

_forever kubectl delete namespace eksler-test-1

_done
echo ""
