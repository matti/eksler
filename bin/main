#!/usr/bin/env bash
set -euo pipefail
. functions.sh

region="${1}"
cluster_name="${2}"
generation="${3}"

bin/eksler create $region $cluster_name

pools="x-1-pre all-1-pre"
for pool in $pools; do
  (
    bin/pools $pool $region $cluster_name $generation
    _done
  ) 2>&1 | sed -le "s#^# ++ pool: $pool: #;" &
done

wait $(jobs -p)

bin/eksler with $region $cluster_name list

# NOTE: install helm charts last so that there are nodes as install is, by default, waiting

bin/eksler with $region $cluster_name \
  helm:apply aws-load-balancer-controller-1 https://aws.github.io/eks-charts aws-load-balancer-controller 1.3.3

bin/eksler with $region $cluster_name \
  helm:fix ingress-nginx-1

bin/eksler with $region $cluster_name \
  helm:apply ingress-nginx-1 https://kubernetes.github.io/ingress-nginx ingress-nginx 4.0.16

# bin/eksler with $region $cluster_name \
#   helm:apply prometheus-1 https://prometheus-community.github.io/helm-charts prometheus 15.0.4

# bin/eksler with $region $cluster_name \
#   helm:apply autoscaler-1 https://kubernetes.github.io/autoscaler cluster-autoscaler 9.11.0

_done
echo ""
