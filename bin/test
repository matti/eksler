#!/usr/bin/env bash
set -euo pipefail

REGION=$1
CLUSTER_NAME=$2
network=$3
kubernetes_version=$4

bin/test-cluster "$REGION" "$CLUSTER_NAME" "$network" "$kubernetes_version"

(
  while true; do
    bin/eksler cluster kubectl "$REGION" "$CLUSTER_NAME" delete ns k8s-node-watchdog --ignore-not-found --wait && break
    sleep 1
  done

  while true; do
    bin/eksler cluster kubectl "$REGION" "$CLUSTER_NAME"  -f https://raw.githubusercontent.com/matti/k8s-node-watchdog/main/install.yml && break
    sleep 1
  done
) 2>&1 | sed -le "s#^#k8s-node-watchdog: #;" &

(
  exec bin/test-nodes
) 2>&1 | sed -le "s#^#test-nodes: #;" &
(
  exec bin/test-charts
) 2>&1 | sed -le "s#^#test-charts: #;" &

wait

bin/test-test
